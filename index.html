<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
<meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon"  href="favicon.png">

  <title>TextReverse&Replace</title>
  <style>
    *, *:before, *:after {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        transition: width, height, flex .3s;
    }
    html {
        -ms-text-size-adjust: 100%;
        -webkit-text-size-adjust: 100%;
        -webkit-tap-highlight-color: transparent
    }
    body { margin: 0; }
    textarea { resize: none; vertical-align: middle; }
    ::selection {
      background-color: #2196f3;
      color: #212121;
    }

    #container {
      position: fixed;
      top: 0;
      left: 0;
      display: flex;
      flex-flow: column nowrap;
      width: 100%;
      height: 100%;
      background-color: #efefef;
      overflow: auto;
    }

    .top {
      flex: 6;
      display: flex;
      flex-flow: row nowrap;
    }
    
    button[data-clipboard-target] {
      position: relative;
      outline: 0;
    }
    
    button[data-clipboard-target]:before {
      content: "复制好啦 , 哥哥";
      vertical-align: middle;
      font-size: 90%;
      color: #efefef;
      background-color: #212121dd;
      border-radius: 4px;
      padding: 2px 5px;
      display: block;
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
    }
    
    button[data-clipboard-target]:after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid #212121dd;
      border-top-color: transparent;
      border-left-color: transparent;
      border-right-color: transparent;
    }
    button[data-clipboard-target]:after,
    button[data-clipboard-target]:before {
      transition: .3s;
      opacity: 0;
    }
    button[data-clipboard-target].coped:after,
    button[data-clipboard-target].coped:before {
      opacity: 1;
    }
    

    .top textarea {
      flex: 1;
      overflow: auto;
    }
    .top textarea#result {
      flex: 10;
    }
    
    @media screen and (max-width: 950px) {
      .top { flex-flow: column; }
      .top:hover #result { flex: 1; }
    }

    .bottom {
      flex: 5;
      overflow: auto;
    }

    .bottom textarea {
      width: 22em;
      height: 3em;
    }
    
    
    
    

    .btn,
    button,
    label {
      color: #333;
      background-color: #fff;
      display: inline-block;
      padding: 6px 12px;
      /*margin-bottom: 0;*/
      font-size: 14px;
      font-weight: 400;
      line-height: 1.42857143;
      text-align: center;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-image: none;
      border: 1px solid #ccc;
      border-radius: 4px;
      transition: .3s;
    }


    .btn:hover,
    label:hover,
    button:hover {
      color: #333;
      background-color: #e6e6e6;
      border-color: #adadad;
    }
    
    .btn input,
    label input {
      vertical-align: middle;
      cursor: pointer;
    }
    
    .btn,
    label {
      margin-top: 5px;
      margin-bottom: 5px;
    }

    button.danger {
      color: #fff;
      background-color: #d9534f;
      border-color: #d43f3a;
    }

    button.danger:hover {
      color: #fff;
      background-color: #c9302c;
      border-color: #ac2925;
    }

    button.primary {
      color: #fff;
      background-color: #337ab7;
      border-color: #2e6da4;
    }

    button.primary:hover {
      color: #fff;
      background-color: #286090;
      border-color: #204d74;
    }

    button.sec {
      color: #fff;
      background-color: #4caf50;
      border-color: #9feca5;
    }

    button.sec:hover {
      color: #fff;
      background-color: #429a46;
      border-color: #9feca5;
    }

    button.thi {
      color: #fff;
      background-color: #337ab7;
      border-color: #2e6da4;
    }

    button.thi:hover {
      color: #fff;
      background-color: #286090;
      border-color: #2e6da4;
    }

    input[type=text] {
      width: 100%;
      border: 0;
      outline: 0;
      -webkit-appearance: none;
      background-color: transparent;
      font-size: inherit;
      color: inherit;
      height: 1.41176471em;
      line-height: 1.41176471;
    }
  </style>
</head>

<body>
  <div id="container" @selectstart.prevent>
    <div class="top">
      <!-- <textarea v-model="qr.on ? qrResult : source"></textarea> -->
      <textarea v-model="source"></textarea>
      <textarea :style="textStyle" :value="result" id="result" ></textarea>
    </div>
    <div class="bottom">
      <label>水平翻转
        <input type="checkbox" v-model="horizontalReverse" name="horizontalReverse" title="horizontalReverse">
      </label>
      <label>垂直翻转
        <input type="checkbox" v-model="verticalReverse" name="verticalReverse" title="verticalReverse">
      </label>
      <label>字体大小
        <input type="range" v-model="style.fontSize" name="fontSize" min="5" max="28" step="1"
          title="fontSize">
      </label>
      <label>字体 <select v-model="style.fontFamilySelected" name="fontFamily">
          <option v-for="f in style.fontFamily" :value="f">{{ f }}</option>
        </select></label>
      <label>行间距
        <input type="range" v-model="style.lineHeight" name="lineHeight" min="0" max="28" step="1"
          title="lineHeight">
      </label>
      <label>右对齐
        <input type="checkbox" v-model="style.textAlignRight" name="textAlignRight" title="textAlignRight">
      </label>
      <label>字间距
        <input type="range" v-model="style.letterSpacing" name="letterSpacing" min="0" max="10" step="1"
          title="letterSpacing">
      </label>
      <label>颜色翻转
        <input type="checkbox" v-model="style.reverseFontColor" name="reverseFontColor" title="reverseFontColor">
      </label>
      <label>边框
        <select v-model="borderSlected" name="border">
          <option v-for="b,i in border" :value="i">{{ b }}</option>
        </select>
      </label>
      <br>
      <textarea title="replace" v-model="replaceCmp" name="replace" rows="7" cols="10"></textarea>
      <textarea title="swap" v-model="swapCmp" name="swap" rows="7" cols="10"></textarea>
      <label>替换 replace
        <input type="checkbox" v-model="enableReplace" name="enableReplace" title="enableReplace">
      </label>
      <label>交换 swap
        <input type="checkbox" v-model="enableSwap" name="enableSwap" title="enableSwap">
      </label>

      <!-- 二维码 --><hr>
      <!-- <label>开启二维码转换
        <input type="checkbox" v-model="qr.on" name="qrOn" title="qrOn">
      </label> -->
      <label>
        <input @input="showCode" type="text" v-model="qr.source" name="qrSource" title="qrSource" placeholder="要转换成二维码的字符">
      </label>
      <label>边框 (qr) <select @change="showCode" v-model="qr.borderSlected" name="qrBorder" >
          <option v-for="b,i in qr.border" :value="i">{{ b }}</option>
      </select></label>
      <span class="btn">
        上<input @change="showCode" type="checkbox" v-model="qr.borderOption.t" name="qrBorderOptionT">
        下<input @change="showCode" type="checkbox" v-model="qr.borderOption.b" name="qrBorderOptionB">
        左<input @change="showCode" type="checkbox" v-model="qr.borderOption.l" name="qrBorderOptionL">
        右<input @change="showCode" type="checkbox" v-model="qr.borderOption.r" name="qrBorderOptionR">
      </span>
      <label>字符翻转 (qr)
        <input @change="showCode" type="checkbox" v-model="qr.reverseFont" name="QRreverseFont" title="QRreverseFont">
      </label>
      <button class="primary" @click.enter.stop.prevent="showCode">转换</button>
      <button data-clipboard-target="#result" class="sec" >复制</button>
      <button data-clipboard-target="#result" data-clipboard-action="cut">剪切</button>
      <p>如果觉得二维码字符太长 , 可以只保留上边框</p>
      <div id="qrResult" style="display: none;"></div>
    </div>
  </div>
  <script src="qrcode.js"></script>
  <script src="vue.js"></script>
  <script src="clipboard.min.js"></script>
  <script>

    var data = {
      "source": "\
░░░░░░░█▐▓▓░████▄▄▄█▀▄▓▓▓▌███\n\
░░░░░▄█▌▀▄▓▓▄▄▄▄▀▀▀▄▓▓▓▓▓▌███\n\
░░░▄█▀▀▄▓█▓▓▓▓▓▓▓▓▓▓▓▓▀░▓▌███\n\
░░█▀▄▓▓▓███▓▓▓███▓▓▓▄░░▄▓▐███\n\
░█▌▓▓▓▀▀▓▓▓▓███▓▓▓▓▓▓▓▄▀▓▓▐██\n\
▐█▐██▐░▄▓▓▓▓▓▀▄░▀▓▓▓▓▓▓▓▓▓▌██\n\
█▌███▓▓▓▓▓▓▓▓▐░░▄▓▓███▓▓▓▄▀▐█\n\
█▐█▓▀░░▀▓▓▓▓▓▓▓▓▓██████▓▓▓▓▐█\n\
▌▓▄▌▀░▀░▐▀█▄▓▓██████████▓▓▓▌█\n\
▌▓▓▓▄▄▀▀▓▓▓▀▓▓▓▓▓▓▓▓█▓█▓█▓▓▌█\n\
█▐▓▓▓▓▓▓▄▄▄▓▓▓▓▓▓█▓█▓█▓█▓▓▓▐█\n\
         replace A\n\
         Swap Swim",
      "horizontalReverse": false,
      "verticalReverse": false,
      "enableReplace": false,
      "enableSwap": false,
      "borderSlected": 0,
      "border": ['none', 'lighten', 'darken'],
      "replace": [['replace A', 'With B']],
      "swap": [["▌", "▐"], ["▀", "▄"], ["░", "█"], ["Swap", "Swim"]],
      "style": {
        "fontFamilySelected": 'Arial',
        "fontFamily": [
          'Arial',
          'Verdana',
          'sans-serif',
          'monospace',
          'initial'
        ],
        "reverseFontColor": true,
        "fontSize": 16,
        "lineHeight": 0,
        "letterSpacing": 0,
        "textAlignRight": false,
      },
      // 新增 QR 模块
      "qr": {
        // "on": false,
        "reverseFont": true,
        "borderSlected": 1,
        "borderOption": {
          "t": true,
          "b": true,
          "l": true,
          "r": true
        },
        "border": ['none', 'lighten', 'darken'],
        "transformer": new QRCode(document.querySelector('#qrResult'), { width: 70, height: 70 }),
        "source": ''
      }
    };

    var methods = {
      transformText: function (text) {
        // 替换
        this.enableReplace && this.replace.forEach(function (item, i, array) {
          // TODO 会产生 bug ( 少数情况下 )
          text = text.replaceAll(item[0], item[1]);
        });
        // 互换
        this.enableSwap && this.swap.forEach(function (item, i, array) {
          // TODO 会产生 bug ( 少数情况下 )
          text = text.swap(item[0], item[1]);
        });
        var textArr = text.split("\n");
        // 垂直翻转
        this.verticalReverse && textArr.reverse();
        // 水平翻转
        this.horizontalReverse && textArr.forEach(function (item, i, arr) {
          arr[i] = item.split("").reverse().join("");
        });
        // 边框
        if (this.borderSlected !== 0) {
          var type = this.borderSlected === 1 ? '░' : '█';
          this.joinBorder(textArr, type);
        }

        return textArr.join("\n");
      },
      joinBorder: function (data, type) {
        data.forEach(function(t, i, a) {
          a[i] = type + a[i] + type;
        });

        var border = [];
        while (data[0].length > 1 &&
          border.length !== data[0].length) {
          border.push(type);
        }

        data.unshift(border.join(''));
        data.push(border.join(''));
      },
      joinBorderQR: function (data, type, option) {
        option = option || {
          t: true,
          b: true,
          l: true,
          r: true
        };
        data.map(row => {
          option.l && row.unshift(type);
          option.r && row.push(type);
        });

        var border = [];
        while (data[0].length > 1 &&
          border.length !== data[0].length) {
          border.push(type);
        }

        option.t && data.unshift(border);
        option.b && data.push(border);
      },
      getEncodeText: function (text) {
        this.qr.transformer.makeCode(text);
        return this._code2Text(this.qr.transformer._oQRCode.modules, "░▀▄█", 1, 2);
      },
      _code2Text: function (code, texts, column, row) {
        // 添加边框
        if (this.qr.borderSlected !== 0) {
          var type = this.qr.borderSlected !== 1;
          this.joinBorderQR(code, type, this.qr.borderOption);
        }
        // 字符翻转
        var trueValue = this.qr.reverseFont ? 0 : 1;
        var falseValue = this.qr.reverseFont ? 1 : 0;
        // 开始转换
        var outputStr = "";
        for (var y = 0; y < code.length; y += row) {
          for (var x = 0; x < code[y].length; x += column) {
            // 每个 column*row 的字符格子
            var index = "0B";
            for (var tempCol = column; tempCol > 0; tempCol--) {
              for (var tempRow = row; tempRow > 0; tempRow--) {
                var yy = y + tempRow - 1;
                var xx = x + tempCol - 1;
                if ((typeof code[yy]) === 'undefined' || (typeof code[yy][xx]) === 'undefined') {
                  index += 0;
                  continue;
                }
                index += code[yy][xx] ? trueValue : falseValue;
              }
            }
            outputStr += texts.charAt(index.toString(2));
          }
          outputStr += "\n";
        }

        console.log(outputStr);
        return outputStr;
      },
      showCode: function () {
        // this.replace = [];
        // this.swap = [];
        this.source = this.getEncodeText(this.qr.source);
      },
      copyResult: function() {
        // this.select() document.execCommand("Copy");
      }
    };

    var computed = {
      replaceCmp: {
        get: function () {
          return JSON.stringify(this.replace, null, 0);
        },
        set: function (newValue) {
          this.replace = JSON.parse(newValue) || [];
        }
      },
      swapCmp: {
        get: function () {
          return JSON.stringify(this.swap, null, 0);
        },
        set: function (newValue) {
          this.swap = JSON.parse(newValue) || [];
        }
      },
      textStyle: function () {
        var s = this.style;
        return {
          'background-color': s.reverseFontColor ? '#212121' : '#f8f8f8',
          'color': s.reverseFontColor ? '#f8f8f8' : '#212121',
          'font-family': s.fontFamilySelected,
          'fontSize': s.fontSize === 0 ? 'initial' : s.fontSize + 'px',
          'line-height': s.lineHeight == 0 ? 'initial' : s.lineHeight + 'px',
          'letter-spacing': s.letterSpacing == 0 ? 'initial' : s.letterSpacing + 'px',
          'text-align': s.textAlignRight ? 'right' : 'left'
        };
      },
      result: function () {
        return this.transformText(this.source);
      }
    };

    var app = new Vue({
      el: '#container',
      data: data,
      methods: methods,
      computed: computed,
      beforeCreate: initStringUtil,
      mounted: function() {
        var clipboard = new ClipboardJS(document.querySelectorAll('button[data-clipboard-target]'));
        var stop = 0;
        clipboard.on('success', function(e) {
            console.info('Action:', e.action);
            console.info('Text:', e.text);
            console.info('Trigger:', e.trigger);
            e.trigger.classList.add('coped');
            clearTimeout(stop);
            stop = setTimeout(function() {
              e.trigger.classList.remove('coped');
            }, 2000);
            e.clearSelection();
        });
      }
    });

    function initStringUtil() {
      String.prototype.replaceAll = function (f, e) {
        return this.split(f).join(e);
      };
      String.prototype.swap = function (a, b) {
        var tmp = this.split(a);
        for (var i = 0; i < tmp.length; i++) {
          tmp[i] = tmp[i].split(b).join(a);
        }
        return tmp.join(b);
      }
    }


  </script>
</body>

</html>